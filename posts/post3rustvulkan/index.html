<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Brad Dragun (LuuBluum)"><meta name=description content="With validation layers set up back in part 2, we can finally move on to adding physical and logical devices! All of the code can be found at this repo."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Learning Vulkan with Rust, Part 3: Adding Physical and Logical Devices"><meta name=twitter:description content="With validation layers set up back in part 2, we can finally move on to adding physical and logical devices! All of the code can be found at this repo."><meta property="og:title" content="Learning Vulkan with Rust, Part 3: Adding Physical and Logical Devices"><meta property="og:description" content="With validation layers set up back in part 2, we can finally move on to adding physical and logical devices! All of the code can be found at this repo."><meta property="og:type" content="article"><meta property="og:url" content="https://LuuBluum.github.io/posts/post3rustvulkan/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-01T15:54:34-07:00"><meta property="article:modified_time" content="2022-08-01T15:54:34-07:00"><title>LuuBluum's Coding Blog</title><link rel=canonical href=https://LuuBluum.github.io/posts/post3rustvulkan/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.6b1a4fbc48955b72aea7913e43fabeb45e8bc120da5aa41b598dd33adcac4b59.css integrity="sha256-axpPvEiVW3Kup5E+Q/q+tF6LwSDaWqQbWY3TOtysS1k=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.39e41a7f16bdf8cb16e43cae7d714fa1016f1d2d2898a5b3f27f42c9979204e2.css integrity="sha256-OeQafxa9+MsW5DyufXFPoQFvHS0omKWz8n9CyZeSBOI=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.102.3"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>LuuBluum's Coding Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://LuuBluum.github.io/posts/post3rustvulkan/>Learning Vulkan with Rust, Part 3: Adding Physical and Logical Devices</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2022-08-01T15:54:34-07:00>August 1, 2022</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
6-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/rust/>Rust</a>
<span class=separator>â€¢</span>
<a href=/categories/vulkan/>Vulkan</a></div></div></header><div><p>With validation layers set up back in <a href=https://luubluum.github.io/posts/post2rustvulkan/>part 2</a>, we can finally move on to adding <a href=https://vulkan-tutorial.com/Drawing_a_triangle/Setup/Physical_devices_and_queue_families>physical</a> and <a href=https://vulkan-tutorial.com/Drawing_a_triangle/Setup/Logical_device_and_queues>logical</a> devices! All of the code can be found at <a href=https://github.com/LuuBluum/Learning-Vulkan-with-Rust>this repo</a>.</p><p>Last time, we left the code in a bit of a messy state. Let&rsquo;s clean it up real quick:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=font-weight:700>impl</span> HelloTriangleApplication {
</span></span><span style=display:flex><span>    <span style=font-weight:700>pub</span> <span style=font-weight:700>fn</span> new() -&gt; <span style=font-weight:700>Self</span> {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> (entry, instance, debug_messenger) = HelloTriangleApplication::init_vulkan();
</span></span><span style=display:flex><span>        Self {
</span></span><span style=display:flex><span>            entry: <span style=font-weight:700>entry</span>,
</span></span><span style=display:flex><span>            instance: <span style=font-weight:700>instance</span>,
</span></span><span style=display:flex><span>            debug_messenger: <span style=font-weight:700>debug_messenger</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> init_vulkan() -&gt; (
</span></span><span style=display:flex><span>        ash::Entry,
</span></span><span style=display:flex><span>        ash::Instance,
</span></span><span style=display:flex><span>        vk::DebugUtilsMessengerEXT,
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> entry = Entry::linked();
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> instance = HelloTriangleApplication::create_instance(&amp;entry).unwrap();
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> debug_messenger = HelloTriangleApplication::create_debug_messenger(&amp;entry, &amp;instance);
</span></span><span style=display:flex><span>        (entry, instance, debug_messenger)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> create_instance(entry: <span>&amp;</span><span style=font-weight:700>ash</span>::Entry) -&gt; <span style=font-weight:700>prelude</span>::VkResult&lt;ash::Instance&gt; {
</span></span><span style=display:flex><span>        <span style=font-weight:700>if</span> !HelloTriangleApplication::check_validation_layer_support(&amp;entry)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            panic!(<span style=font-style:italic>&#34;Could not find support for all layers!&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> app_info = vk::ApplicationInfo {
</span></span><span style=display:flex><span>            s_type: <span style=font-weight:700>vk</span>::StructureType::APPLICATION_INFO,
</span></span><span style=display:flex><span>            p_application_name: <span style=font-weight:700>unsafe</span> { CStr::from_bytes_with_nul_unchecked(<span style=font-style:italic>&#34;Hello Triangle\0&#34;</span>.as_bytes()).as_ptr() },
</span></span><span style=display:flex><span>            application_version: <span style=font-weight:700>vk</span>::make_api_version(0, 1, 0, 0),
</span></span><span style=display:flex><span>            p_engine_name: <span style=font-weight:700>unsafe</span> { CStr::from_bytes_with_nul_unchecked(<span style=font-style:italic>&#34;No Engine\0&#34;</span>.as_bytes()).as_ptr() },
</span></span><span style=display:flex><span>            engine_version: <span style=font-weight:700>vk</span>::make_api_version(0, 1, 0, 0),
</span></span><span style=display:flex><span>            api_version: <span style=font-weight:700>vk</span>::make_api_version(0, 1, 0, 0),
</span></span><span style=display:flex><span>            ..Default::default()
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> create_info = vk::InstanceCreateInfo {
</span></span><span style=display:flex><span>            p_application_info: <span>&amp;</span><span style=font-weight:700>app_info</span>,
</span></span><span style=display:flex><span>            enabled_layer_count: <span style=font-weight:700>VALIDATION_LAYERS</span>.len() <span style=font-weight:700>as</span> <span>u32</span>,
</span></span><span style=display:flex><span>            pp_enabled_layer_names: <span style=font-weight:700>VALIDATION_LAYERS</span>.as_ptr(),
</span></span><span style=display:flex><span>            enabled_extension_count: <span style=font-weight:700>REQUIRED_EXTENSIONS</span>.len() <span style=font-weight:700>as</span> <span>u32</span>,
</span></span><span style=display:flex><span>            pp_enabled_extension_names: <span style=font-weight:700>REQUIRED_EXTENSIONS</span>.as_ptr(),
</span></span><span style=display:flex><span>            p_next: <span>&amp;</span><span style=font-weight:700>HelloTriangleApplication</span>::populate_debug_messenger_create_info() <span style=font-weight:700>as</span> *<span style=font-weight:700>const</span> _ <span style=font-weight:700>as</span> *<span style=font-weight:700>const</span> c_void,
</span></span><span style=display:flex><span>            ..Default::default()
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> check_validation_layer_support(entry: <span>&amp;</span><span style=font-weight:700>ash</span>::Entry) -&gt; <span>bool</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> layer_properties = entry.enumerate_instance_layer_properties().unwrap();
</span></span><span style=display:flex><span>        <span style=font-weight:700>for</span> layer <span style=font-weight:700>in</span> VALIDATION_LAYERS {
</span></span><span style=display:flex><span>            <span style=font-weight:700>if</span> <span style=font-weight:700>let</span> None = layer_properties.iter().find(|l| {
</span></span><span style=display:flex><span>                <span style=font-style:italic>// This horrible construction is because Vulkan operates with C strings and Rust does not
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>               <span style=font-weight:700>unsafe</span> { &amp;CStr::from_ptr(l.layer_name.as_ptr()).to_str().unwrap() == &amp;CStr::from_ptr(*layer).to_str().unwrap() }
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=font-weight:700>return</span> <span style=font-weight:700>false</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=font-weight:700>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> create_debug_messenger(entry: <span>&amp;</span><span style=font-weight:700>ash</span>::Entry, instance: <span>&amp;</span><span style=font-weight:700>ash</span>::Instance) -&gt; <span style=font-weight:700>vk</span>::DebugUtilsMessengerEXT {
</span></span><span style=display:flex><span>        <span style=font-weight:700>unsafe</span> { DebugUtils::new(&amp;entry, &amp;instance).create_debug_utils_messenger(&amp;HelloTriangleApplication::populate_debug_messenger_create_info(), None).unwrap() }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> populate_debug_messenger_create_info() -&gt; <span style=font-weight:700>vk</span>::DebugUtilsMessengerCreateInfoEXT {
</span></span><span style=display:flex><span>        vk::DebugUtilsMessengerCreateInfoEXT {
</span></span><span style=display:flex><span>            s_type: <span style=font-weight:700>vk</span>::StructureType::DEBUG_UTILS_MESSENGER_CREATE_INFO_EXT,
</span></span><span style=display:flex><span>            message_severity: <span style=font-weight:700>vk</span>::DebugUtilsMessageSeverityFlagsEXT::VERBOSE |
</span></span><span style=display:flex><span>                              vk::DebugUtilsMessageSeverityFlagsEXT::WARNING |
</span></span><span style=display:flex><span>                              vk::DebugUtilsMessageSeverityFlagsEXT::ERROR,
</span></span><span style=display:flex><span>            message_type: <span style=font-weight:700>vk</span>::DebugUtilsMessageTypeFlagsEXT::GENERAL |
</span></span><span style=display:flex><span>                          vk::DebugUtilsMessageTypeFlagsEXT::VALIDATION |
</span></span><span style=display:flex><span>                          vk::DebugUtilsMessageTypeFlagsEXT::PERFORMANCE,
</span></span><span style=display:flex><span>            pfn_user_callback: Some(debug_callback),
</span></span><span style=display:flex><span>            ..Default::default()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>pub</span> <span style=font-weight:700>fn</span> run(<span style=font-weight:700>mut</span> self) -&gt; ! {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> (event_loop, window) = HelloTriangleApplication::init_window().unwrap();
</span></span><span style=display:flex><span>        event_loop.run(<span style=font-weight:700>move</span> |event, _, control_flow| {
</span></span><span style=display:flex><span>            *control_flow = ControlFlow::Wait;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=font-weight:700>match</span> event {
</span></span><span style=display:flex><span>                Event::WindowEvent {
</span></span><span style=display:flex><span>                    event: <span style=font-weight:700>WindowEvent</span>::CloseRequested,
</span></span><span style=display:flex><span>                    window_id,
</span></span><span style=display:flex><span>                } <span style=font-weight:700>if</span> window_id == window.id() =&gt; {
</span></span><span style=display:flex><span>                    self.cleanup();
</span></span><span style=display:flex><span>                    *control_flow = ControlFlow::Exit
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                _ =&gt; (),
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> init_window() -&gt; Result&lt;(winit::event_loop::EventLoop&lt;()&gt;, winit::window::Window), winit::error::OsError&gt; {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> event_loop = EventLoop::new();
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> window = WindowBuilder::new()
</span></span><span style=display:flex><span>            .with_resizable(<span style=font-weight:700>false</span>)
</span></span><span style=display:flex><span>            .with_inner_size(PhysicalSize::new(WIDTH, HEIGHT))
</span></span><span style=display:flex><span>            .build(&amp;event_loop)?;
</span></span><span style=display:flex><span>        Ok((event_loop, window))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> cleanup(&amp;<span style=font-weight:700>mut</span> self) {
</span></span><span style=display:flex><span>        <span style=font-weight:700>unsafe</span> {
</span></span><span style=display:flex><span>            DebugUtils::new(&amp;self.entry, &amp;self.instance).destroy_debug_utils_messenger(self.debug_messenger, None);
</span></span><span style=display:flex><span>            self.instance.destroy_instance(None);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now it more closely follows the tutorial. Well, almost: we stripped out the bulk of the <code>void</code>-returning functions and our <code>main_loop</code> is still completely encompassed within <code>run</code>, with <code>init</code>-methods being regulated to <code>new</code> (since we&rsquo;re keeping local copies), but that&rsquo;s fine. If we wanted we could drop keeping anything saved locally and instead have everything instanced within <code>run</code>, but that seems rather clunky. Window initialization, contrary to how the C++ tutorial works, does not need to happen before Vulkan initialization here, so we&rsquo;re fine handling things this way. Especially given that <code>run</code> completely takes over the control flow and that there&rsquo;s no way to return from its execution. Perhaps a more structured approach for this sort of design would create the window immediately after reading whatever necessary data is needed to configure the window creation, and then promptly enter the event loop and instantiate everything in there, but that&rsquo;s not how this tutorial is structured and so neither will be our code.</p><h2 id=physical-devices>Physical Devices
<a class=heading-link href=#physical-devices><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Anyway, we can now start adding in handling for physical devices:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>    <span style=font-weight:700>fn</span> init_vulkan() -&gt; (
</span></span><span style=display:flex><span>        ash::Entry,
</span></span><span style=display:flex><span>        ash::Instance,
</span></span><span style=display:flex><span>        vk::DebugUtilsMessengerEXT,
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> entry = Entry::linked();
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> instance = HelloTriangleApplication::create_instance(&amp;entry).unwrap();
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> debug_messenger = HelloTriangleApplication::create_debug_messenger(&amp;entry, &amp;instance);
</span></span><span style=display:flex><span>        HelloTriangleApplication::pick_physical_device();
</span></span><span style=display:flex><span>        (entry, instance, debug_messenger)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> pick_physical_device() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>As for populating this function, it turns out we can make it closely mimic the C++ equivalent:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>    <span style=font-weight:700>fn</span> pick_physical_device(instance: <span>&amp;</span><span style=font-weight:700>ash</span>::Instance) -&gt; <span style=font-weight:700>vk</span>::PhysicalDevice {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> <span style=font-weight:700>mut</span> physical_device: Option&lt;vk::PhysicalDevice&gt; = None;
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> devices = <span style=font-weight:700>unsafe</span> { instance.enumerate_physical_devices().unwrap() };
</span></span><span style=display:flex><span>        <span style=font-weight:700>if</span> devices.len() == 0 {
</span></span><span style=display:flex><span>            panic!(<span style=font-style:italic>&#34;Failed to find GPUs with Vulkan support!&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=font-weight:700>for</span> device <span style=font-weight:700>in</span> devices {
</span></span><span style=display:flex><span>            <span style=font-weight:700>if</span> HelloTriangleApplication::is_device_suitable(&amp;instance, &amp;device) {
</span></span><span style=display:flex><span>                physical_device = Some(device);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        physical_device.unwrap()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> is_device_suitable(_device: <span>&amp;</span><span style=font-weight:700>vk</span>::PhysicalDevice) -&gt; <span>bool</span> {
</span></span><span style=display:flex><span>        <span style=font-weight:700>true</span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>The only differences here are the panics, which of course are not nearly as proper a way of handling things as would be passing up results, but for the sake of simplicity we&rsquo;ll just keep them as panics for now. We skip down now to trying to find queue families. Funny enough, the tutorial here explains the beauty of C++17&rsquo;s <code>optional</code> type. Go figure. So, with a little bit of finagling, we can create something a bit more Rust-like for the queue family check than a simple for loop with an index counter:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>    <span style=font-weight:700>fn</span> is_device_suitable(instance: <span>&amp;</span><span style=font-weight:700>ash</span>::Instance, device: <span>&amp;</span><span style=font-weight:700>vk</span>::PhysicalDevice) -&gt; <span>bool</span> {
</span></span><span style=display:flex><span>        HelloTriangleApplication::find_queue_familes(instance, device).is_some()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> find_queue_familes(instance: <span>&amp;</span><span style=font-weight:700>ash</span>::Instance, device: <span>&amp;</span><span style=font-weight:700>vk</span>::PhysicalDevice) -&gt; Option&lt;<span>usize</span>&gt; {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> queue_family_properties = <span style=font-weight:700>unsafe</span> { instance.get_physical_device_queue_family_properties(*device) };
</span></span><span style=display:flex><span>        queue_family_properties.iter().position(|&amp;queue_family| queue_family.queue_flags &amp; vk::QueueFlags::GRAPHICS == vk::QueueFlags::GRAPHICS)
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>The self-check against the bitwise operation there is effectively the same as coercing it to <code>bool</code>. Just cleaner. No point adding in their quick-exit optimizations and whatnot: we already have that baked in. Though honestly in C++ if you&rsquo;re interating over a vector and care about the index, just go with an old-school <code>for</code> loop rather than bothering with a for-each. Otherwise it just looks silly.</p><h2 id=logical-devices>Logical Devices
<a class=heading-link href=#logical-devices><i class="fa fa-link" aria-hidden=true></i></a></h2><p>The logical device starts similarly to the physical device, though in this case we&rsquo;re instantiating the structure rather than being provided it from the instance:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>impl</span> HelloTriangleApplication {
</span></span><span style=display:flex><span>    <span style=font-weight:700>pub</span> <span style=font-weight:700>fn</span> new() -&gt; <span style=font-weight:700>Self</span> {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> (entry, instance, debug_messenger, physical_device, device) = HelloTriangleApplication::init_vulkan();
</span></span><span style=display:flex><span>        Self {
</span></span><span style=display:flex><span>            entry: <span style=font-weight:700>entry</span>,
</span></span><span style=display:flex><span>            instance: <span style=font-weight:700>instance</span>,
</span></span><span style=display:flex><span>            debug_messenger: <span style=font-weight:700>debug_messenger</span>,
</span></span><span style=display:flex><span>            physical_device: <span style=font-weight:700>physical_device</span>,
</span></span><span style=display:flex><span>            device: <span style=font-weight:700>device</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> init_vulkan() -&gt; (
</span></span><span style=display:flex><span>        ash::Entry,
</span></span><span style=display:flex><span>        ash::Instance,
</span></span><span style=display:flex><span>        vk::DebugUtilsMessengerEXT,
</span></span><span style=display:flex><span>        vk::PhysicalDevice,
</span></span><span style=display:flex><span>        ash::Device,
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> entry = Entry::linked();
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> instance = HelloTriangleApplication::create_instance(&amp;entry).unwrap();
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> debug_messenger = HelloTriangleApplication::create_debug_messenger(&amp;entry, &amp;instance);
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> physical_device = HelloTriangleApplication::pick_physical_device(&amp;instance);
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> device = HelloTriangleApplication::create_logical_device();
</span></span><span style=display:flex><span>        (entry, instance, debug_messenger, physical_device, device)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> create_logical_device() -&gt; <span style=font-weight:700>vk</span>::Device {
</span></span><span style=display:flex><span>        <span style=font-style:italic>// Actually create the device here
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The first object of the struct we wish to populate will be info about the queue. We&rsquo;ll be needing the instance and the physical device to queue that again:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>    <span style=font-weight:700>fn</span> create_logical_device(instance: <span>&amp;</span><span style=font-weight:700>ash</span>::Instance, physical_device: <span>&amp;</span><span style=font-weight:700>vk</span>::PhysicalDevice) -&gt; <span style=font-weight:700>ash</span>::Device {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> device_queue_create_info = vk::DeviceQueueCreateInfo {
</span></span><span style=display:flex><span>            s_type: <span style=font-weight:700>vk</span>::StructureType::DEVICE_QUEUE_CREATE_INFO,
</span></span><span style=display:flex><span>            queue_family_index: <span style=font-weight:700>HelloTriangleApplication</span>::find_queue_familes(instance, physical_device).unwrap() <span style=font-weight:700>as</span> <span>u32</span>,
</span></span><span style=display:flex><span>            queue_count: 1,
</span></span><span style=display:flex><span>            p_queue_priorities: <span>&amp;</span>1.0,
</span></span><span style=display:flex><span>            ..Default::default()
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Still incomplete, but at least now we have the device create info. Ignore that questionable value for <code>p_queue_priorities</code>; apparently that&rsquo;s what it wants. Now we fill out the create info proper, and obtain our logical device:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>    <span style=font-weight:700>fn</span> create_logical_device(instance: <span>&amp;</span><span style=font-weight:700>ash</span>::Instance, physical_device: <span>&amp;</span><span style=font-weight:700>vk</span>::PhysicalDevice) -&gt; <span style=font-weight:700>ash</span>::Device {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> device_queue_create_info = vk::DeviceQueueCreateInfo {
</span></span><span style=display:flex><span>            s_type: <span style=font-weight:700>vk</span>::StructureType::DEVICE_QUEUE_CREATE_INFO,
</span></span><span style=display:flex><span>            queue_family_index: <span style=font-weight:700>HelloTriangleApplication</span>::find_queue_familes(instance, physical_device).unwrap() <span style=font-weight:700>as</span> <span>u32</span>,
</span></span><span style=display:flex><span>            queue_count: 1,
</span></span><span style=display:flex><span>            p_queue_priorities: <span>&amp;</span>1.0,
</span></span><span style=display:flex><span>            ..Default::default()
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> device_features = vk::PhysicalDeviceFeatures {
</span></span><span style=display:flex><span>            ..Default::default()
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> device_create_info = vk::DeviceCreateInfo {
</span></span><span style=display:flex><span>            s_type: <span style=font-weight:700>vk</span>::StructureType::DEVICE_CREATE_INFO,
</span></span><span style=display:flex><span>            queue_create_info_count: 1,
</span></span><span style=display:flex><span>            p_queue_create_infos: <span>&amp;</span><span style=font-weight:700>device_queue_create_info</span>,
</span></span><span style=display:flex><span>            p_enabled_features: <span>&amp;</span><span style=font-weight:700>device_features</span>,
</span></span><span style=display:flex><span>            enabled_layer_count: <span style=font-weight:700>VALIDATION_LAYERS</span>.len() <span style=font-weight:700>as</span> <span>u32</span>,
</span></span><span style=display:flex><span>            pp_enabled_layer_names: <span style=font-weight:700>VALIDATION_LAYERS</span>.as_ptr(),
</span></span><span style=display:flex><span>            ..Default::default()
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        <span style=font-weight:700>unsafe</span> { instance.create_device(*physical_device, &amp;device_create_info, None).unwrap() }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> cleanup(&amp;<span style=font-weight:700>mut</span> self) {
</span></span><span style=display:flex><span>        <span style=font-weight:700>unsafe</span> {
</span></span><span style=display:flex><span>            self.device.destroy_device(None);
</span></span><span style=display:flex><span>            DebugUtils::new(&amp;self.entry, &amp;self.instance).destroy_debug_utils_messenger(self.debug_messenger, None);
</span></span><span style=display:flex><span>            self.instance.destroy_instance(None);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Now we just do one last little bit to get the graphics queue:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=font-weight:700>pub</span> <span style=font-weight:700>struct</span> <span style=font-weight:700>HelloTriangleApplication</span> {
</span></span><span style=display:flex><span>    entry: <span style=font-weight:700>ash</span>::Entry,
</span></span><span style=display:flex><span>    instance: <span style=font-weight:700>ash</span>::Instance,
</span></span><span style=display:flex><span>    debug_messenger: <span style=font-weight:700>vk</span>::DebugUtilsMessengerEXT,
</span></span><span style=display:flex><span>    physical_device: <span style=font-weight:700>vk</span>::PhysicalDevice,
</span></span><span style=display:flex><span>    device: <span style=font-weight:700>ash</span>::Device,
</span></span><span style=display:flex><span>    graphics_queue: <span style=font-weight:700>vk</span>::Queue,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>impl</span> HelloTriangleApplication {
</span></span><span style=display:flex><span>    <span style=font-weight:700>pub</span> <span style=font-weight:700>fn</span> new() -&gt; <span style=font-weight:700>Self</span> {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> (entry, instance, debug_messenger, physical_device, device, graphics_queue) = HelloTriangleApplication::init_vulkan();
</span></span><span style=display:flex><span>        Self {
</span></span><span style=display:flex><span>            entry: <span style=font-weight:700>entry</span>,
</span></span><span style=display:flex><span>            instance: <span style=font-weight:700>instance</span>,
</span></span><span style=display:flex><span>            debug_messenger: <span style=font-weight:700>debug_messenger</span>,
</span></span><span style=display:flex><span>            physical_device: <span style=font-weight:700>physical_device</span>,
</span></span><span style=display:flex><span>            device: <span style=font-weight:700>device</span>,
</span></span><span style=display:flex><span>            graphics_queue: <span style=font-weight:700>graphics_queue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=font-weight:700>fn</span> init_vulkan() -&gt; (
</span></span><span style=display:flex><span>        ash::Entry,
</span></span><span style=display:flex><span>        ash::Instance,
</span></span><span style=display:flex><span>        vk::DebugUtilsMessengerEXT,
</span></span><span style=display:flex><span>        vk::PhysicalDevice,
</span></span><span style=display:flex><span>        ash::Device,
</span></span><span style=display:flex><span>        vk::Queue,
</span></span><span style=display:flex><span>    ) {
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> entry = Entry::linked();
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> instance = HelloTriangleApplication::create_instance(&amp;entry).unwrap();
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> debug_messenger = HelloTriangleApplication::create_debug_messenger(&amp;entry, &amp;instance);
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> physical_device = HelloTriangleApplication::pick_physical_device(&amp;instance);
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> device = HelloTriangleApplication::create_logical_device(&amp;instance, &amp;physical_device);
</span></span><span style=display:flex><span>        <span style=font-weight:700>let</span> graphics_queue = <span style=font-weight:700>unsafe</span> { device.get_device_queue(HelloTriangleApplication::find_queue_familes(&amp;instance, &amp;physical_device).unwrap() <span style=font-weight:700>as</span> <span>u32</span>, 0) };
</span></span><span style=display:flex><span>        (entry, instance, debug_messenger, physical_device, device, graphics_queue)
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>And we&rsquo;re there! We have the complete implementation of our physical and logical devices. The next thing to tackle is actually synchronizing all of this Vulkan creation with the window itself, so that we can actually draw things.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>Â©
2022
Brad Dragun (LuuBluum)
Â·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script></body></html>